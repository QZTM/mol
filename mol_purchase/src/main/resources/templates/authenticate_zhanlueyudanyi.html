<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.0, user-scalable=0">
	<!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
	<meta charset="UTF-8">
	<title th:text="${pagenametitlefront+'供应商认证'}"></title>
	<!-- Bootstrap -->
	<link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
	<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery) -->
	<script th:src="@{/js/jquery-3.2.1.min.js}"></script>
	<!-- 加载 Bootstrap 的所有 JavaScript 插件。 -->
	<script th:src="@{/js/bootstrap.min.js}"></script>
	<script th:src="@{/js/picker.min.js}"></script>
	<script th:src="@{/js/city.js}"></script>

	<style>
		.uploadimg-out-div{
			position:relative;
			width:100%;
		}
		.uploadimg-input{
			position: absolute;
			left:0;
			top:0;
			opacity:0;
			filter:alpha(opacity=0);
			z-index: 6;
			padding:0px 0px 0px 0px;
		}
		input:focus{
			border:  none;
		}
		.picker .picker-panel .wheel-wrapper .wheel {
			font-size:14px!important;
		}
		.msgDiv{
			background-color:rgb(230, 216, 216);
			position: fixed;
			top:40%;
			left:40%;
			z-index:9999;
			opacity:0.8;
			border-radius: 10px;
			padding:1% 1% 1% 1%;
			display: none;
		}
		.msgSpan{
			color:#014fff;
			font-size:14px;
			font-size:14px;
		}
	</style>
</head>
<body>
<!-- 公司名称开始 -->
<div class="input-group" style="margin:16px 6px 0 10px ">
	<span class="input-group-addon">公司名称：</span>
	<input type="text" class="form-control" placeholder="Company name" aria-describedby="basic-addon1">
</div>
<!-- 公司名称结束 -->
<!-- 营业执照号开始 -->
<div class="input-group" style="margin:10px 6px 0 10px ">
	<span class="input-group-addon">营业执照号：</span>
	<input type="text" class="form-control" placeholder="Business license number" aria-describedby="basic-addon1">
</div>
<!--营业执照号开始 -->

<!-- 上传营业执照图片开始 -->
<div style="margin: 10px 10px 0 10px;">
	<ul class="nav nav-tabs">
		<li role="presentation" class="active"><a href="#">上传营业执照图像</a></li>
	</ul>
	<div class="control-group uploadimg-out-div" id="div-licenceimg" style="width:100%;text-align: center;">
		<div id="preview-bussinessLicence" style="width:100%">
			<img th:src="@{/img/upimg.png}" class="uploadimg-img input-group">
		</div>
		<input type="file" id="bussinessLicence" class="uploadimg-input" onchange="preview(this)"  accept="image/gif,image/jpeg,image/jpg,image/png"/>
	</div>

</div>
<!-- 上传营业执照图片结束 -->
<!-- 所在地开始 -->
<div class="input-group" style="margin:10px 6px 0 10px ">
	<span class="input-group-addon">所在地：</span>
	<span class="form-control" aria-describedby="basic-addon1" id="sel_city"><span style="color:#999">点击选取省市区县</span></span>
</div>
<!-- 所在地结束 -->
<!-- 注册地开始 -->
<div class="input-group" style="margin:10px 6px 0 10px;clear: both; ">
	<span class="input-group-addon">注册地：</span>
	<input type="text" class="form-control" placeholder="Place of registration" aria-describedby="basic-addon1">
</div>
<!-- 注册地结束 -->
<!-- 所属行业开始 -->
<div class="input-group" style="margin:10px 6px 0 10px ">
	<span class="input-group-addon">所属行业：</span>
	<span class="form-control" aria-describedby="basic-addon1" id="sel_trade"><span style="color:#aaa">点击选取所属行业</span></span>
</div>
<!-- 所属行业结束 -->
<!-- 经营范围开始 -->
<div style="clear: both;margin:6px 6px 0 10px;" id="bussiness-scope-out-div">
	<ul class="nav nav-tabs">
		<li role="presentation" class="active"><a href="#bussiness-scope-out-div">经营范围</a></li>
	</ul>
	<textarea style="width: 100%; "></textarea>
</div>
<!-- 经营范围结束 -->
<!-- 上传法人身份证正反面开始 -->
<!-- 上传法人身份证正面 -->
<div style="margin: 6px 10px 0 10px;">
	<ul class="nav nav-tabs">
		<li role="presentation" class="active"><a href="#">上传法人身份证图像</a></li>
	</ul>
	<div class="control-group uploadimg-out-div" id="div-legal-person-front" style="width:100%;text-align: center">
		<div id="preview-legalBodyIdFront" style="width:100%">
			<img th:src="@{/img/upimg.png}" class="uploadimg-img input-group">
		</div>
		<input type="file" id="legalBodyIdFront" class="uploadimg-input" onchange="preview(this)"  accept="image/gif,image/jpeg,image/jpg,image/png"/>
		<p style="position: absolute;margin: 0 auto;width:100%;height:30px;text-align: center;padding-top:6px;" class="uploadimg-p">身份证正面</p>
	</div>

	<!--上传法人身份证反面-->
	<div class="control-group uploadimg-out-div" id="div-legal-person-back" style="margin-top:40px;width:100%">
		<div id="preview-legalBodyIdBack"  style="width:100%">
			<img th:src="@{/img/upimg.png}" class="uploadimg-img input-group">
		</div>
		<input type="file" id="legalBodyIdBack" class="uploadimg-input" onchange="preview(this)"  accept="image/gif,image/jpeg,image/jpg,image/png"/>
		<span style="position: absolute;margin: 0 auto;width:100%;height:30px;text-align: center;padding-top:6px;" class="uploadimg-p">身份证反面</span>
	</div>
</div>
<!-- 上传法人身份证正反面结束 -->
<!-- 法人姓名开始 -->
<div class="input-group" style="margin:40px 6px 0 10px ;clear: both;">
	<span class="input-group-addon">法人姓名：</span>
	<input type="text" class="form-control" placeholder="Name of legal person" aria-describedby="basic-addon1">
</div>
<!-- 法人姓名结束 -->
<!-- 身份证号开始 -->
<div class="input-group" style="margin:6px 6px 0 10px ">
	<span class="input-group-addon">身份证号：</span>
	<input type="text" class="form-control" placeholder="ID number" aria-describedby="basic-addon1">
</div>
<!-- 身份证号结束 -->
<!-- 上传战略供应商协议开始 -->
<div style="margin: 10px 10px 0 10px;">
	<ul class="nav nav-tabs">
		<li role="presentation" class="active"><a href="#">上传战略供应商协议</a></li>
	</ul>
	<div class="control-group uploadimg-out-div" id="div-supplier-protocol" style="width:100%;text-align: center">
		<div id="preview-supplierProtocol" style="width:100%">
			<img th:src="@{/img/upimg.png}" class="uploadimg-img input-group">
		</div>
		<input type="file" id="supplierProtocol" class="uploadimg-input" onchange="fileSelected(this)"  accept=".pdf,.doc"/>
		<p class="uploadimg-p" id="supplierProtocolFileNameP"></p><p id="uploadProgressNUm"></p>
	</div>
</div>
<!-- 上传战略供应商协议结束 -->
<script>
	function fileSelected(file) {
		var theFile = file.files[0];
		if (theFile) {
			var fileSize = 0;
			if (theFile.size > 1024 * 1024){
				var fileSizeNum = Math.round(theFile.size * 100 / (1024 * 1024)) / 100;
				if(fileSizeNum > 20){
					alert("文件超过20M无法上传");
					return ;
				}
				fileSize = (Math.round(theFile.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
			} else
				fileSize = (Math.round(theFile.size * 100 / 1024) / 100).toString() + 'KB';

			$("#supplierProtocolFileNameP").text(theFile.name);
			uploadFile(theFile,"protocolFile");
		}
	}

	function uploadFile(file,whichFile) {
		var fd = new FormData();
		fd.append("fileToUpload", file);
		fd.append("whichFile",whichFile);
		var xhr = new XMLHttpRequest();
		xhr.upload.addEventListener("progress", uploadProgress, false);
		xhr.addEventListener("load", uploadComplete, false);
		xhr.addEventListener("error", uploadFailed, false);
		xhr.addEventListener("abort", uploadCanceled, false);
		xhr.open("POST", "/auth/upload/file"); //修改成自己的接口
		xhr.send(fd);
	}

	function uploadProgress(evt) {
		if (evt.lengthComputable) {
			var percentComplete = Math.round(evt.loaded * 100 / evt.total);
			console.log(percentComplete.toString());
			document.getElementById('uploadProgressNUm').innerHTML = percentComplete.toString() + '%';
		} else {
			document.getElementById('uploadProgressNUm').innerHTML = 'unable to compute';
		}
	}

	function uploadComplete(evt) {
		/* 服务器端返回响应时候触发event事件*/
		alert(evt.target.responseText);
	}

	function uploadFailed(evt) {
		alert("There was an error attempting to upload the file.");
	}

	function uploadCanceled(evt) {
		alert("The upload has been canceled by the user or the browser dropped the connection.");
	}
</script>
<!-- 其他补充材料开始 -->
<div style="margin-top: 6px;">
	<ul class="nav nav-tabs">
		<li role="presentation" class="active"><a href="#">其他补充材料（专利/代理商资质等材料）</a></li>
	</ul>
	<div style="float: left;" class="col-xs-6 col-md-4">
		<div class="control-group">
			<label class="col-md-3 control-label span3"></label>
			<div class="col-md-9">
				<img th:src="@{/img/upimg.png}" width="70px" height="70px">
			</div>
		</div>

		<div class="control-group">

			<div class="col-md-9">
				<div class="input-group">
					<label class="input-group-btn">
						<input class="file" type="file" name="img5" style="left: -9999px; position: absolute;">
						<span class="btn btn-default">点击上传</span>
					</label>
				</div>
			</div>
		</div>
	</div>
	<!-- 第二个 -->
	<div style="float: left;" class="col-xs-6 col-md-4">
		<div class="control-group">
			<label class="col-md-3 control-label span3"></label>
			<div class="col-md-9">
				<img th:src="@{/img/upimg.png}" width="70px" height="70px">
			</div>
		</div>

		<div class="control-group">

			<div class="col-md-9">
				<div class="input-group">
					<label class="input-group-btn">
						<input class="file" type="file" name="img6" style="left: -9999px; position: absolute;">
						<span class="btn btn-default">点击上传</span>
					</label>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 其他补充材料结束 -->
<!-- 手机号开始 -->
<div class="input-group" style="margin:130px 6px 0 10px ">
	<span class="input-group-addon">手机号：</span>
	<input type="text" class="form-control" placeholder="Phone number" aria-describedby="basic-addon1">
</div>
<!-- 手机号结束 -->
<!-- 验证码开始 -->
<div class="input-group" style="margin:6px 6px 0 5px ">
	<div class="input-group" style="float: left;margin-left: 6px;">
		<input type="text" class="form-control" placeholder="请输入验证码" aria-describedby="basic-addon2">
	</div>
	<div class="input-group" style="float: right;">
		<input class="form-control" type="button" name="" value="获取验证码" onclick="settime(this);" />
	</div>
</div>
<!-- 验证码结束 -->
<!-- 提交开始 -->
<button type="button" class="btn btn-danger" style="margin-top: 20px;width: 100%;">提交</button>
<!-- 提交结束 -->
<!-- 提示框  -->
<div id="msgDiv" class="msgDiv"></div>
<span class="msgSpan" id="msgSpanContent"></span>
</div>
</body>
<script  th:inline="javascript">
	$(function() {
		var a = changeInputFileSize;
		a();
	})


	/**
	 * 上传相关js
	 */

	/*上传图片：*/
	/**
	 * 获取到图片后
	 * @type {string}      在input标签上面 onChange="preview(this)"即可
	 * 逻辑：
	 *      1.通过input   type="file"获取图片   file.files[0]
	 *      2.判断，如果图片大小大于1M则压缩   photoCompress(文件，图片质量参数，回调函数），在回调函数中获取返回值，返回值即是压缩后的图片的base64码
	 *      3.显示。如果图片经过压缩，那么把压缩后获取到的base64赋值给图片的src;
	 *              如果图片不超过1M,没有经过压缩，那么通过FileReader()获得图片的base64码赋值给src
	 *      4.把图片的base64码转换为blob
	 *
	 *
	 */
	var bl="",theFile;
	function preview(file) {
		//首先检测浏览器对FileReader的兼容性

		/*获取图片对应的父节点*/
		var thisEveId = file.id;
		var pervDivId = "preview-" + thisEveId;
		var prevDiv = document.getElementById(pervDivId);
		var orgId = [[${session.supplier.pkSupplier}]];



		/*获取文件*/
		theFile = file.files[0];
		console.log("压缩前：" + theFile.size / 1024 + "k");
		//var width = file.files[0].width;
		if(undefined == theFile){
			console.log("theFile == undefined");
			return ;
		}
		if(theFile.size/1024 > 100) { //大于1M，进行压缩上传
			console.log("theFile.size/1024 > 100");
			photoCompress(theFile, {
				quality: 0.7
			}, function(base64Codes){
				console.log("压缩后：" + base64Codes.length / 1024 + "k");
				$("#"+pervDivId).children("img").attr("src", base64Codes);
				$("#"+pervDivId).children("img").css("width", (window.innerWidth-40)+"px");
				bl = convertBase64UrlToBlob(base64Codes);

				uploadImg(bl,file.id);
				console.log("bl:");
				console.log(bl);
			});
		}else{
			console.log("theFile.size/1024 <= 100");
			var ready=new FileReader();
			/*开始读取指定的Blob对象或File对象中的内容. 当读取操作完成时,readyState属性的值会成为DONE,如果设置了onloadend事件处理程序,则调用之.同时,result属性中将包含一个data: URL格式的字符串以表示所读取文件的内容.*/
			ready.readAsDataURL(theFile);
			ready.onload=function(){
				var re=this.result;
				console.log("ready.onload....this.result:");
				console.log(this.result);
				$("#"+pervDivId).children("img").attr("src", this.result);
				$("#"+pervDivId).children("img").css("width", (window.innerWidth-40)+"px");
				bl = convertBase64UrlToBlob(this.result);
				uploadImg(bl,file.id);
				console.log("bl:");
				console.log(bl);
			}
		}
		setTimeout("changeInputFileSize($('#"+pervDivId+"'))",500);

	};




	/**
	 *       用url方式表示的base64图片数据
	 */
	function convertBase64UrlToBlob(urlData){
		var arr = urlData.split(','), mime = arr[0].match(/:(.*?);/)[1],
				bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
		while(n--){
			u8arr[n] = bstr.charCodeAt(n);
		}
		return new Blob([u8arr], {type:mime});
	};
	function photoCompress(file,w,objDiv){
		var ready=new FileReader();
		/*开始读取指定的Blob对象或File对象中的内容. 当读取操作完成时,readyState属性的值会成为DONE,
        如果设置了onloadend事件处理程序,则调用之.
        同时,result属性中将包含一个data: URL格式的字符串以表示所读取文件的内容.*/
		ready.readAsDataURL(file);
		ready.onload=function(){
			var re=this.result;
			canvasDataURL(re,w,objDiv)
		}
	};


	/**
	 * 按比例缩放图片，通过canvas新生成图片并把新生成的图片转换为base64码返回
	 * @param path
	 * @param obj
	 * @param callback
	 */
	function canvasDataURL(path, obj, callback){
		var img = new Image();
		img.src = path;
		img.onload = function(){
			var that = this;
			// 默认按比例压缩
			var w = that.width,
					h = that.height,
					scale = w / h;
			w = obj.width || w;
			h = obj.height || (w / scale);
			var quality = 0.7;  // 默认图片质量为0.7
			//生成canvas
			var canvas = document.createElement('canvas');
			var ctx = canvas.getContext('2d');
			// 创建属性节点
			var anw = document.createAttribute("width");
			anw.nodeValue = w;
			var anh = document.createAttribute("height");
			anh.nodeValue = h;
			canvas.setAttributeNode(anw);
			canvas.setAttributeNode(anh);
			ctx.drawImage(that, 0, 0, w, h);
			// 图像质量
			if(obj.quality && obj.quality <= 1 && obj.quality > 0){
				quality = obj.quality;
			}
			// quality值越小，所绘制出的图像越模糊
			var base64 = canvas.toDataURL('image/jpeg', quality);
			// 回调函数返回base64的值
			callback(base64);
		}
	};

	/**
	 * 动态的设置input的宽、高及位置，以便覆盖图片，使点击图片等同于点击input,起到点击图片即可以选择图片的效果
	 * @param prevDiv       input父节点的jquery对象
	 */
	function changeInputFileSize(prevDiv){
		console.log("changeInputFileSize....prevDiv:");
		console.log(prevDiv);
		var windowWidth = window.innerWidth;
		if(prevDiv){
			console.log("prevDiv...");
			console.log(prevDiv.children("img"));
			//获取页面宽度
			//获取图片的宽度
			var imageWidth = prevDiv.children("img")['0'].width;
			var imageHeight =  prevDiv.children("img")['0'].height;
			console.log("prevDiv...windowWidth:"+windowWidth+",imageWidth:"+imageWidth+",imageHeight:"+imageHeight);
			prevDiv.next().css("width",imageWidth);
			prevDiv.next().css("height",imageHeight);
			prevDiv.next().css("left",(((windowWidth-imageWidth)/2)-10)+"px");
			prevDiv.next().next().css("top",(imageHeight+3)+"px");
			prevDiv.children("img").css("left",(((windowWidth-imageWidth)/2)-10)+"px");
		}else{
			$(".uploadimg-input").each(function(){
				var imageWidth = $(this).parent().children("div").children("img")['0'].scrollWidth;
				var imageHeight = $(this).parent().children("div").children("img")['0'].scrollHeight;
				//设置input宽:
				$(this).css("width",imageWidth);
				$(this).next().css("top",(imageHeight+2)+"px")
				$(this).css("height",imageHeight);
				$(this).css("left",(((window.innerWidth-imageWidth)/2)-10)+"px");
				$(this).parent().children("div").children("img").css("left",(((windowWidth-imageWidth)/2)-10)+"px");
			})
		}
	};

	/**
	 * 上传图片
	 * @param bl                    图片的blob
	 * @param whichImg              自定义的图片种类，例如身份证正面，反面，营业执照等，值是在后端的MicroAuthController类中定义的常量
	 * @returns {Promise<any>}
	 */
	function uploadImg(bl,whichImg){
		var fd = new FormData();
		fd.append("file",bl);
		fd.append("whichImg",whichImg);
		return new Promise(function(resolve, reject){
			$.ajax({
				url: '/auth/upload/img',
				data:fd,
				type: 'post',
				//contentType: 'application/json;charset=UTF-8',
				// headers: {
				//     'Content-Type': 'application/x-www-form-urlencoded'  //multipart/form-data;boundary=--xxxxxxx   application/json
				// },
				contentType : false,
				processData: false,
				contentType: false,
				success:function(data){
					resolve(data);
					console.log(data);
				},fail:function(data){
					reject(data);
				}
			})
		})
	}





	/**
	 *
	 * 城市三级联动
	 * @type {number}
	 * 1.把省份放进去
	 * 2.省份更改事件，动态去获取该省的市
	 * 3.市更改事件，动态去获取该市的县
	 */


	var nameEl = document.getElementById('sel_city');

	var first = []; /* 省，直辖市 */
	var second = []; /* 市 */
	var third = []; /* 镇 */

	var selectedIndex = [0, 0, 0]; /* 默认选中的地区 */

	var checked = [0, 0, 0]; /* 已选选项 */

	function creatList(obj, list){
		obj.forEach(function(item, index, arr){
			var temp = new Object();
			temp.text = item.name;
			temp.value = index;
			list.push(temp);
		})
	}

	creatList(city, first);

	if (city[selectedIndex[0]].hasOwnProperty('sub')) {
		creatList(city[selectedIndex[0]].sub, second);
	} else {
		second = [{text: '', value: 0}];
	}

	if (city[selectedIndex[0]].sub[selectedIndex[1]].hasOwnProperty('sub')) {
		creatList(city[selectedIndex[0]].sub[selectedIndex[1]].sub, third);
	} else {
		third = [{text: '', value: 0}];
	}

	var picker = new Picker({
		data: [first, second, third],
		selectedIndex: selectedIndex,
		title: '地址选择'
	});

	picker.on('picker.select', function (selectedVal, selectedIndex) {
		var text1 = first[selectedIndex[0]].text;
		var text2 = second[selectedIndex[1]].text;
		var text3 = third[selectedIndex[2]] ? third[selectedIndex[2]].text : '';

		nameEl.innerText = text1 + ' ' + text2 + ' ' + text3;
	});

	picker.on('picker.change', function (index, selectedIndex) {
		if (index === 0){
			firstChange();
		} else if (index === 1) {
			secondChange();
		}

		function firstChange() {
			second = [];
			third = [];
			checked[0] = selectedIndex;
			var firstCity = city[selectedIndex];
			if (firstCity.hasOwnProperty('sub')) {
				creatList(firstCity.sub, second);

				var secondCity = city[selectedIndex].sub[0]
				if (secondCity.hasOwnProperty('sub')) {
					creatList(secondCity.sub, third);
				} else {
					third = [{text: '', value: 0}];
					checked[2] = 0;
				}
			} else {
				second = [{text: '', value: 0}];
				third = [{text: '', value: 0}];
				checked[1] = 0;
				checked[2] = 0;
			}

			picker.refillColumn(1, second);
			picker.refillColumn(2, third);
			picker.scrollColumn(1, 0)
			picker.scrollColumn(2, 0)
		}

		function secondChange() {
			third = [];
			checked[1] = selectedIndex;
			var first_index = checked[0];
			if (city[first_index].sub[selectedIndex].hasOwnProperty('sub')) {
				var secondCity = city[first_index].sub[selectedIndex];
				creatList(secondCity.sub, third);
				picker.refillColumn(2, third);
				picker.scrollColumn(2, 0)
			} else {
				third = [{text: '', value: 0}];
				checked[2] = 0;
				picker.refillColumn(2, third);
				picker.scrollColumn(2, 0)
			}
		}

	});

	picker.on('picker.valuechange', function (selectedVal, selectedIndex) {
		console.log(selectedVal);
		console.log(selectedIndex);
	});

	nameEl.addEventListener('click', function () {
		picker.show();
	});









	/**
	 * 所属行业选择：
	 * 思路：
	 * 1.异步获取第一级分类的数据
	 * 2.判断第一级的第一个分类是否有子分类，如果有的话获取其下面的二级分类
	 * 3.判断第二级分类下面是否还有分类，如果有的话获取
	 */
	var tradeName = document.getElementById('sel_trade');
	var firstTrade = []; /* 第一级分类*/
	var secondTrade = []; /* 第二级分类 */
	var thirdTrade = []; /* 第三级分类 */
	var selectedIndexTrade = [0, 0, 0]; /* 默认选中的地区 */
	var checkedTrade = [0, 0, 0]; /* 已选选项 */
	var tradePicker = new Picker({
		data: [firstTrade, secondTrade, thirdTrade],
		selectedIndex: selectedIndexTrade,
		title: '行业选择'
	});;

	/*获取分类数据方法，whichLeval可以为1，2,3, 如果是第2  、3级，需要给parentId*/
	function getTrade(whichLeval,parentId){
		hiddenConfirm();
		var url = "";
		switch (whichLeval) {
			case  1 :
				url = "/getTypeFirst";
				break;
			case 2 :
				url = "/getTypeByParentId";
				break;
			case  3 :
				url = "/getTypeByParentId";
				break;
			default:
				console.log("获取分类信息参数不对：，，whichLeval?:"+whichLeval+",,,parentId:"+parentId);
				break;
		}
		return new Promise((resolve, reject) => {
			$.ajax({
				url:"/item"+url,
				data:{id:parentId},
				type:"post",
				dataType:"json",
				success:function(res){
					showConfirm();
					console.log(res);
					resolve(res);
				},
				fail:function(res){
					showConfirm();
					alertMsg("获取数据异常，请重试",3000);
					console.log(res);
					reject(res);
				}
			})
		})
	}

	/*获取第一级分类，然后根据返回的第一级分类的第一个分类的情况获取第二级分类，然后根据返回的第二级分类的第一个分类的情况获取第三级分类*/
	getTrade(1).then(function(res){
		/*获取到第一层分类信息后：
        * 1：把第一层分类数据放入tradeFirst
        * 2:如果tradeFirst的第一个元素含有子元素，那么获取该分类的子元素放入tradeSecond
        * 3:如果tradeSecond的第一个元素含有子元素，那么获取该分类的子元素放入tradeSecond*/
		creatTradeList(res.result,firstTrade);
		if (firstTrade[selectedIndexTrade[0]].canOpen) {
			/*如果firstTrade的第一个元素有子元素，那么根据id去获取他下面的子元素并放入secondTrade*/
			getTrade(2,firstTrade[selectedIndexTrade[0]].value).then(function(res2){
				creatTradeList(res2.result, secondTrade);
				if (secondTrade[selectedIndexTrade[1]].canOpen) {
					getTrade(3,secondTrade[selectedIndexTrade[1]].value).then(function(res3){
						creatTradeList(res3.result,thirdTrade);
						tradePicker = new Picker({
							data: [firstTrade, secondTrade, thirdTrade],
							selectedIndex: selectedIndexTrade,
							title: '行业选择'
						});
						setPickerChange();
					},function(res3){
						console.log(res3);
					})
				} else {
					thirdTrade = [{text: '', value: 0}];
					tradePicker = new Picker({
						data: [firstTrade, secondTrade, thirdTrade],
						selectedIndex: selectedIndexTrade,
						title: '行业选择'
					});
					setPickerChange();
				}
			},function(res2){
				console.log("getTrade(2,firstTrade[selectedIndexTrade[0]].id......fail......res2:");
				console.log(res2);
			})
		} else {
			secondTrade = [{text: '', value: 0}];
			tradePicker = new Picker({
				data: [firstTrade, secondTrade, thirdTrade],
				selectedIndex: selectedIndexTrade,
				title: '行业选择'
			});
			setPickerChange();
		}
	},function(res){
		alertMsg("网络异常，请稍后再试");
		console.log(res.message);
	})
	function creatTradeList(obj, list){
		obj.forEach(function(item, index, arr){
			var temp = new Object();
			temp.text = item.name;
			temp.value = item.id;
			temp.canOpen = item.canOpen;
			list.push(temp);
		})
	}

	function setPickerChange(){
		tradePicker.on('picker.select', function (selectedVal, selectedIndex) {
			var text1 = firstTrade[selectedIndex[0]].text;
			var text2 = secondTrade[selectedIndex[1]].text;
			var text3 = thirdTrade[selectedIndex[2]] ? thirdTrade[selectedIndex[2]].text : '';
			tradeName.innerText = text1 + ' ' + text2 + ' ' + text3;
		});

		tradePicker.on('picker.change', function (index, selectedIndex) {
			console.log("picker...change...index:"+index+",,,selectedIndex:"+selectedIndex);
			if (index === 0){
				firstTradeChange();
			} else if (index === 1) {
				secondTradeChange();
			}
			function firstTradeChange() {
				secondTrade = [];
				thirdTrade = [];
				checkedTrade[0] = selectedIndex;
				var firstTradeObj = firstTrade[selectedIndex];
				if (firstTradeObj.canOpen) {
					getTrade(2,firstTradeObj.value).then(function(res){
						creatTradeList(res.result, secondTrade);
						tradePicker.refillColumn(1, secondTrade);
						tradePicker.scrollColumn(1, 0)
						var secondTradeFirst = secondTrade[0];
						if(secondTradeFirst.canOpen){
							checkedTrade[1] = 0;
							getTrade(3,secondTradeFirst.value).then(function(res2){
								creatTradeList(res2.result,thirdTrade);
								tradePicker.refillColumn(2, thirdTrade);
								tradePicker.scrollColumn(2, 0)
							},function(res2){
								console.log("getTrade(3,"+secondTradeFirst.value+")...fail....res:");
								console.log(res2);
							})
						}else{
							thirdTrade = [{text: '', value: 0}];
							checkedTrade[2] = 0;
						}
					},function(res){
						console.log(res);
						console.log("firstTradeChange()....getTrade(2,"+firstTrade.value+")...fail...")
					})
				} else {
					secondTrade = [{text: '', value: 0}];
					thirdTrade = [{text: '', value: 0}];
					checkedTrade[1] = 0;
					checkedTrade[2] = 0;
					tradePicker.refillColumn(1, secondTrade);
					tradePicker.scrollColumn(1, 0)
					tradePicker.refillColumn(2, thirdTrade);
					tradePicker.scrollColumn(2, 0)
				}
			}

			function secondTradeChange() {
				thirdTrade = [];
				checkedTrade[1] = selectedIndex;
				var first_index = checkedTrade[0];
				if (secondTrade[checkedTrade[1]].canOpen) {
					getTrade(3,secondTrade[checkedTrade[1]].value).then(function(res){
						creatTradeList(res.result,thirdTrade);
						tradePicker.refillColumn(2, thirdTrade);
						tradePicker.scrollColumn(2, 0)
					},function(res){
						console.log("secondTradeChange()...fail...");
						console.log(res);
					})
				} else {
					thirdTrade = [{text: '', value: 0}];
					checkedTrade[2] = 0;
					tradePicker.refillColumn(2, thirdTrade);
					tradePicker.scrollColumn(2, 0)
				}
			}

		});
		tradePicker.on('picker.valuechange', function (selectedVal, selectedIndex) {
			console.log("picker.valuechange");
			console.log(selectedVal);
			console.log(selectedIndex);
		});
	}
	function showConfirm(){
		$(".confirm").css("display","flex");
	}
	function hiddenConfirm(){
		$(".confirm").css("display","none");
	}
	tradeName.addEventListener('click', function () {
		tradePicker.show();
	});





















	//验证码
	var count = 60;

	function settime(val) {
		if (count == 0) {
			val.removeAttribute("disabled");
			val.value = "发送验证码";
			count = 60;
			return false;
		} else {
			val.setAttribute("disabled", true);
			val.value = "重新发送(" + count + ")";
			count--;
		}
		setTimeout(function() {
			settime(val)
		}, 1000)
	};


	/*弹出消息框*/
	function alertMsg(msg,showTime){
		$("#msgSpanContent").text(msg);
		$(".msgDiv").show()
		if(!showTime){
			showTime = 3000;
		}
		setTimeout(function(){
			$(".msgDiv").hide(200);
		},showTime)
	}


</script>
</html>
